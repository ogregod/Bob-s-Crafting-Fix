<div class="flexrow recipe">
    <div class="sheet-left flexcol">
        {{#if useAttendants}}
            <div class="recipe-card attendants flexcol">
                <div class="flexrow header">
                    <div class="name">{{localize "beaversCrafting.crafting-app.required"}}</div>
                </div>
                <div class="section flexcol">
                    {{#each recipe.required}}
                        <div class="section flexcol" style="margin-left:20px">
                            {{#each this}}
                                {{>beavers-recipe-component component=this key=@key type="required" group=@../key clickable=../../displayIngredients hasCraftedFlag=../../hasCraftedFlag editable=../../editable}}
                                <div class="beavers-seperator"></div>
                            {{/each}}
                            {{#if ../editable}}
                                <div class="flexrow">
                                    <div class="drop-area" data-id="{{@key}}">{{localize "beaversCrafting.recipe.orItem"}}</div>
                                </div>
                            {{/if}}
                        </div>
                    {{/each}}
                    {{#if editable}}
                        <div class="flexrow">
                            <div class="drop-area" data-id="">{{localize "beaversCrafting.recipe.addItem"}}</div>
                        </div>
                    {{/if}}
                </div>
            </div>
        {{/if}}
        <div class="recipe-card flexcol cost">
            <div class="flexrow header">
                <div class="name">{{localize "beaversCrafting.crafting-app.cost"}}</div>
                {{#if editable}}
                    <div class="action flexrow">
                        {{#unless recipe.currency}}
                            <a class="item-add">
                                <i class="fa-solid fa-coins"></i>
                            </a>
                        {{/unless}}
                    </div>
                {{/if}}
            </div>
            <div class="section flexcol">
                {{#if recipe.currency}}
                    <div class="currencies flexcol">
                        <div class="flexrow beavers-component">
                            <select {{#unless editable}}disabled{{/unless}}
                                    name="flags.beavers-crafting.recipe.currency.name" class="name">
                                    {{#each currencies}}
                                        <option value="{{this.id}}" {{#if (eq this.id ../recipe.currency.name)}}selected{{/if}}>{{this.label}}</option>
                                    {{/each}}
                            </select>
                            <div class="attribute" style="min-width: 60px;text-align: right;">
                                <input {{#unless editable}}disabled{{/unless}}
                                       name="flags.beavers-crafting.recipe.currency.value" class="attribute"
                                       type="number"
                                       step="any"
                                       value="{{recipe.currency.value}}"/>
                            </div>
                            {{#if editable}}
                                <div class="attribute">
                                    <a class="item-delete">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            {{/if}}
                        </div>
                        <div class="beavers-seperator"></div>
                    </div>
                {{/if}}
                <div class="ingredients flexcol">
                    {{#each recipe.input}}
                    <div class="section flexcol" style="margin-left:20px">
                        {{#each this}}
                            {{>beavers-recipe-component component=this key=@key type="input" group=@../key clickable=../../displayIngredients hasCraftedFlag=../../hasCraftedFlag editable=../../editable}}
                            <div class="beavers-seperator"></div>
                        {{/each}}
                        {{#if ../editable}}
                            <div class="flexrow">
                                <div class="drop-area" data-id="{{@key}}">{{localize "beaversCrafting.recipe.orItem"}}</div>
                            </div>
                        {{/if}}
                    </div>
                    {{/each}}
                    {{#if editable}}
                        <div class="flexrow">
                            <div class="drop-area" data-id="">{{localize "beaversCrafting.recipe.addItem"}}</div>
                        </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
    <div class="sheet-right">
        <div class="recipe-card tests flexcol">
            <div class="flexrow header">
                <div class="name">{{localize "beaversCrafting.recipe.beaversTests.tests"}}</div>
                {{#if recipe.beaversTests}}
                    <div class="attribute flexrow" style="flex-wrap:nowrap;flex-grow:0"
                         title="{{localize "beaversCrafting.recipe.beaversTests.failsHint"}}">
                        {{localize "beaversCrafting.recipe.beaversTests.fails"}}:
                        <input style="width:40px" {{#unless editable}}disabled{{/unless}}
                               name="flags.beavers-crafting.recipe.beaversTests.fails" type="number"
                               step="any"
                               value="{{recipe.beaversTests.fails}}"/>
                    </div>
                    <div class="flexrow" style="flex-wrap:nowrap;flex-grow:0"
                         title="{{localize "beaversCrafting.recipe.beaversTests.consumeHint"}}">
                        <span>{{localize "beaversCrafting.recipe.beaversTests.consume"}}:</span>
                        <input type="checkbox" {{#unless editable}}disabled{{/unless}}
                            {{#if recipe.beaversTests.consume}}checked{{/if}}
                               name="flags.beavers-crafting.recipe.beaversTests.consume">
                    </div>
                {{/if}}
                {{#if editable}}
                    <div class="action flexrow testAnd" title="{{localize "beaversCrafting.recipe.beaversTests.andTestHint"}}">
                        <a class="item-add">
                            <i class="fas fa-plus"></i>
                        </a>
                    </div>
                {{/if}}
            </div>

            {{!-- Quick-add test buttons --}}
            {{#if editable}}
                <div class="test-quick-add-section" style="padding: 8px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; margin-bottom: 8px;">
                    <div style="font-size: 12px; margin-bottom: 6px; font-weight: 600;">Quick Add Test:</div>
                    <div class="flexrow" style="gap: 6px; flex-wrap: wrap;">
                        <button type="button" class="quick-add-test" data-test-type="SkillTest"
                                style="flex: 0 0 auto; padding: 4px 8px; border-radius: 4px; background: var(--beavers-item-background-color); border: 1px solid var(--beavers-item-border-color); cursor: pointer;">
                            <i class="fas fa-user-graduate" style="margin-right: 4px;"></i>Skill Check
                        </button>
                        <button type="button" class="quick-add-test" data-test-type="ToolTest"
                                style="flex: 0 0 auto; padding: 4px 8px; border-radius: 4px; background: var(--beavers-item-background-color); border: 1px solid var(--beavers-item-border-color); cursor: pointer;">
                            <i class="fas fa-tools" style="margin-right: 4px;"></i>Tool Check
                        </button>
                        <button type="button" class="quick-add-test" data-test-type="AbilityTest"
                                style="flex: 0 0 auto; padding: 4px 8px; border-radius: 4px; background: var(--beavers-item-background-color); border: 1px solid var(--beavers-item-border-color); cursor: pointer;">
                            <i class="fas fa-fist-raised" style="margin-right: 4px;"></i>Ability Check
                        </button>
                        <button type="button" class="quick-add-test" data-test-type="IncrementStep"
                                style="flex: 0 0 auto; padding: 4px 8px; border-radius: 4px; background: var(--beavers-item-background-color); border: 1px solid var(--beavers-item-border-color); cursor: pointer;">
                            <i class="fas fa-forward" style="margin-right: 4px;"></i>Auto Progress
                        </button>
                    </div>
                </div>
            {{/if}}

            {{!-- Test presets section --}}
            {{#if editable}}
                <div class="test-presets-section" style="padding: 8px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; margin-bottom: 8px;">
                    <div class="flexrow" style="gap: 6px; align-items: center;">
                        <div style="font-size: 12px; font-weight: 600; flex: 1;">Test Presets:</div>
                        <button type="button" class="save-test-preset"
                                style="flex: 0 0 auto; padding: 4px 8px; border-radius: 4px; background: var(--beavers-item-background-color); border: 1px solid var(--beavers-item-border-color); cursor: pointer;">
                            <i class="fas fa-save" style="margin-right: 4px;"></i>Save Current
                        </button>
                        <select class="load-test-preset"
                                style="flex: 0 0 auto; padding: 4px 8px; border-radius: 4px;">
                            <option value="">Load Preset...</option>
                            {{!-- Populated dynamically --}}
                        </select>
                    </div>
                </div>
            {{/if}}

            <div class="section flexcol">
                {{#if recipe.beaversTests}}
                    {{#each recipe.beaversTests.ands}}
                        <div class="test-and-card" style="margin-bottom: 10px; border: 1px solid var(--beavers-item-border-color); border-radius: 6px; overflow: hidden;">
                            <div class="flexrow header" style="cursor: pointer; background: rgba(0, 0, 0, 0.08);" data-collapse-target="test-and-{{@key}}">
                                <i class="fas fa-chevron-down" style="margin-right: 8px; transition: transform 0.2s;"></i>
                                {{#if ../editable}}
                                    <input type="text"
                                           name="flags.beavers-crafting.recipe.beaversTests.ands.{{@key}}.name"
                                           value="{{#if this.name}}{{this.name}}{{else}}{{localize "beaversCrafting.recipe.beaversTests.test"}} {{@key}}{{/if}}"
                                           placeholder="{{localize "beaversCrafting.recipe.beaversTests.test"}} {{@key}}"
                                           style="flex: 1; border: none; background: transparent; font-weight: bold; padding: 4px;"
                                           onclick="event.stopPropagation();"
                                           title="Click to edit test name"/>
                                {{else}}
                                    <div class="name">{{#if this.name}}{{this.name}}{{else}}{{localize "beaversCrafting.recipe.beaversTests.test"}} {{@key}}{{/if}}</div>
                                {{/if}}
                                <div class="attribute flexrow" style="max-width:40px"
                                     title="{{localize "beaversCrafting.recipe.beaversTests.hitsHint"}}">
                                    {{localize "beaversCrafting.recipe.beaversTests.hits"}}:
                                    <input {{#unless ../editable}}disabled{{/unless}}
                                           name="flags.beavers-crafting.recipe.beaversTests.ands.{{@key}}.hits" type="number"
                                           step="any"
                                           value="{{this.hits}}"
                                           onclick="event.stopPropagation();"/>
                                </div>
                                {{#if ../editable}}
                                    <div class="action flexrow testOr"
                                         title="{{localize "beaversCrafting.recipe.beaversTests.orTestHint"}}">
                                        <a class="item-add" data-and="{{@key}}" onclick="event.stopPropagation();">
                                            <i class="fas fa-plus"></i>
                                        </a>
                                    </div>
                                {{/if}}
                            </div>
                            <div id="test-and-{{@key}}" class="test-and-content" style="padding: 10px;">
                                {{#each this.ors}}
                                <div class="flexrow" style="line-height:20px;margin:2px 0px 2px 10px;">
                                    <div class="flexcol beavers-line" style="flex-wrap:nowrap;">
                                        {{{beavers-test this (beavers-object "disabled" (not ../../editable) "minimized" (not ../../editable) "prefixName" (concat "flags.beavers-crafting.recipe.beaversTests.ands."@../key ".ors." @key)) }}}
                                    </div>
                                    {{#if ../../editable}}
                                        <div class="attribute" style="flex:0;width:30px;flex-basis:auto;margin-top:5px;text-align: center;">
                                            <a class="item-delete" data-and="{{@../key}}" data-or="{{@key}}" onclick="event.stopPropagation();">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    {{/if}}
                                </div>
                                {{#unless @last}}
                                    <div class="beavers-seperator" style="margin:3px 0px 3px;"></div>
                                {{/unless}}
                                {{/each}}
                            </div>
                        </div>
                    {{/each}}
                {{/if}}
            </div>
        </div>
        <div class="recipe-card results flexcol">
            <div class="flexrow header">
                <div class="name">{{localize "beaversCrafting.recipe.results"}}</div>
                {{#if editable}}
                    <div class="action"></div>
                {{/if}}
            </div>
            <div class="section flexcol">
                    {{#each recipe.output}}
                    <div class="section flexcol" style="margin-left:20px">
                        {{#each this}}
                            {{>beavers-recipe-component component=this key=@key type="output" group=@../key hasCraftedFlag=false clickable=../../displayResults editable=../../editable}}
                            <div class="beavers-seperator"></div>
                        {{/each}}
                        {{#if ../editable}}
                            <div class="flexrow">
                                <div class="drop-area" data-id="{{@key}}">{{localize "beaversCrafting.recipe.orItem"}}</div>
                            </div>
                        {{/if}}
                    </div>
                    {{/each}}
                    {{#if editable}}
                        <div class="flexrow">
                            <div class="drop-area" data-id="">{{localize "beaversCrafting.recipe.addItem"}}</div>
                        </div>
                    {{/if}}
            </div>
        </div>
    </div>
</div>